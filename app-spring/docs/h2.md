# ADR-001: Modularização de Dependências para H2 e Testes JPA no Spring Boot 4

## Status
Aceito

## Contexto
Ao migrar/atualizar o projeto para **Spring Boot 4.x** (lançado em 2025), observamos duas quebras comportamentais comuns relacionadas ao H2 Database e testes com `@DataJpaTest`:

1. **H2 Console não aparece mais** (404 ao acessar `/h2-console`):
    - No Spring Boot 3.x, adicionar apenas `com.h2database:h2` (runtime) + `spring.h2.console.enabled=true` era suficiente. A auto-configuração do console web estava embutida no jar monolítico `spring-boot-autoconfigure`.
    - No Spring Boot 4.x, a auto-configuração foi **modularizada**: o console web (servlet, UI, etc.) foi movido para um módulo separado (`spring-boot-h2console`). O driver H2 sozinho não ativa mais o console.

2. **@DataJpaTest não compila ou falha em runtime** (ex: "cannot resolve symbol DataJpaTest" ou "No suitable driver" / "Failed to configure embedded database"):
    - No Spring Boot 3.x, `spring-boot-starter-test` incluía suporte implícito para slices como `@DataJpaTest`.
    - No Spring Boot 4.x, o starter de teste foi quebrado em módulos específicos. O suporte à anotação `@DataJpaTest` (incluindo auto-config de JPA em testes, `TestEntityManager`, transações rollback, etc.) agora exige o starter dedicado `spring-boot-starter-data-jpa-test` (scope test).
    - Além disso, o driver H2 **não** vem mais "de graça" nos testes se não for explicitamente incluído (via `com.h2database:h2` scope test/runtime ou transitivo via `spring-boot-h2console`).

Testes confirmados no projeto:
- Só `spring-boot-starter-data-jpa-test` → quebra (falta driver H2 e anotação).
- `spring-boot-h2console` + `spring-boot-starter-data-jpa-test` → `@DataJpaTest` funciona (driver vem transitivo).
- `com.h2database:h2` (test/runtime) + `spring-boot-starter-data-jpa-test` → `@DataJpaTest` funciona (console não aparece).
- Nenhum dos dois → quebra (esperado).

Referências oficiais:
- Spring Boot 4.0 Migration Guide (GitHub spring-projects/spring-boot)
- Spring Boot 4 Modularization (ex: vídeos e artigos de Dan Vega, Medium posts sobre H2 case study)
- Documentação: `spring-boot-h2console` e `spring-boot-starter-data-jpa-test` são starters modulares novos.

## Decisão
Adotamos a seguinte configuração mínima e recomendada no `pom.xml` para suportar:

- Banco H2 embedded em **dev/runtime** (se necessário)
- Console H2 web em **dev** (opcional, mas útil para debugging)
- Testes com `@DataJpaTest` funcionando com H2 in-memory

```xml
<!-- Produção/Dev: JPA + driver H2 (para rodar app com H2) -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>runtime</scope> <!-- ou sem scope; permite uso em dev -->
</dependency>

<!-- Console H2 web (opcional - só se quiser acessar http://localhost:8080/h2-console) -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-h2console</artifactId>
    <!-- sem scope = runtime; pode usar developmentOnly se preferir -->
</dependency>

<!-- Testes: suporte obrigatório ao @DataJpaTest -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa-test</artifactId>
    <scope>test</scope>
</dependency>

<!-- Driver H2 explícito para testes (garante classpath mesmo sem h2console) -->
<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <scope>test</scope>
</dependency>

